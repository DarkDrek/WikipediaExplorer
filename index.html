<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <style>

        .link {
            fill: none;
            stroke: #666;
            stroke-width: 1.5px;
        }

        #licensing {
            fill: green;
        }

        .link.licensing {
            stroke: green;
        }

        .link.resolved {
            stroke-dasharray: 0, 2 1;
        }

        circle {
            fill: #ccc;
            stroke: #333;
            stroke-width: 1.5px;
        }

        text {
            font: 10px sans-serif;
            pointer-events: none;
            text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff;
        }

    </style>
    <link rel="stylesheet" href="css/prettyPhoto.css" type="text/css" media="screen" charset="utf-8" />
</head>
<body>
<script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="//marvl.infotech.monash.edu/webcola/cola.v3.min.js"></script>
<script src="MediawikiJS.js"></script>
<script src="chain.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script src="js/jquery.prettyPhoto.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" charset="utf-8">
    $(document).ready(function(){
        $("a[rel^='prettyPhoto']").prettyPhoto({
            social_tools: false
        });
    });
</script>

<script>
    var mwjs = new MediaWikiJS('http://en.wikipedia.org', null, null);
    var linksFromData = function (data) {
        var pages = data.query.pages;
        var Links = pages[Object.keys(pages)[0]].links.map(function (obj) {
                    return obj.title;
                }
        );

        return Links.map(function (link) {
            return {source: pages[Object.keys(pages)[0]].title, target: link, type: "suit"};
        });
    };

    mwjs.send({
        action: 'query',
        prop: 'links',
        pllimit: '5',
        //titles: 'Gmina Tolkmicko',
        generator: 'random',
        grnnamespace: '0'
    }, function (data) {
        var links = linksFromData(data);
        var chainArray = [function (data, next) {
            next(links)
        }];

        links.forEach(function (element, index, array) {
                    chainArray.push(function (data, next) {
                        mwjs.send({
                            action: 'query',
                            prop: 'links',
                            pllimit: '10',
                            titles: element.target
                        }, function (siteData) {
                            var links = linksFromData(siteData);
                            next(data.concat(links));
                        });
                    });
                }
        );

        chainArray.push(function (result, api) {

            var nodes = {};

            // Compute the distinct nodes from the links.
            result.forEach(function (link) {
                link.source = nodes[link.source] || (nodes[link.source] = {name: link.source});
                link.target = nodes[link.target] || (nodes[link.target] = {name: link.target});
            });

            var width = window.innerWidth * 0.9, height = window.innerHeight * 0.9;

            var force = cola.d3adaptor()
                    .nodes(d3.values(nodes))
                    .links(result)
                    .size([width, height])
                    .avoidOverlaps(true)
                    .symmetricDiffLinkLengths(100, 1.7)
                    .on("tick", tick)
                    .start();

            var svg = d3.select("body").append("svg")
                    .attr("width", width)
                    .attr("height", height);

            // Per-type markers, as they don't inherit styles.
            svg.append("defs").selectAll("marker")
                    .data(["suit", "licensing", "resolved"])
                    .enter().append("marker")
                    .attr("id", function (d) {
                        return d;
                    })
                    .attr("viewBox", "0 -5 10 10")
                    .attr("refX", 15)
                    .attr("refY", -1.5)
                    .attr("markerWidth", 6)
                    .attr("markerHeight", 6)
                    .attr("orient", "auto")
                    .append("path")
                    .attr("d", "M0,-5L10,0L0,5");

            var path = svg.append("g").selectAll("path")
                    .data(force.links())
                    .enter().append("path")
                    .attr("class", function (d) {
                        return "link " + d.type;
                    })
                    .attr("marker-end", function (d) {
                        return "url(#" + d.type + ")";
                    });

            var circle = svg.append("g").selectAll("circle")
                    .data(force.nodes())
                    .enter().append("circle")
                    .attr("r", 6)
                    .on('click', function (c) {
                        /*var popup = new $.Popup({
                            width: 800,
                            height: 600
                        });
                        popup.open('http://en.wikipedia.org/wiki/' + c.name, 'external', undefined);*/
                        $.prettyPhoto.open('http://en.wikipedia.org/wiki/' + c.name + '?iframe=true&width=70%&height=70%');
                        //window.open('http://en.wikipedia.org/wiki/' + c.name);
                    });

            var text = svg.append("g").selectAll("text")
                    .data(force.nodes())
                    .enter().append("text")
                    .attr("x", 8)
                    .attr("y", ".31em")
                    .text(function (d) {
                        return d.name;
                    });

            // Use elliptical arc path segments to doubly-encode directionality.
            function tick() {
                path.attr("d", linkArc);
                circle.attr("transform", transform);
                text.attr("transform", transform);
            }

            function linkArc(d) {
                var dx = d.target.x - d.source.x,
                        dy = d.target.y - d.source.y,
                        dr = Math.sqrt(dx * dx + dy * dy);
                return "M" + d.source.x + "," + d.source.y + "A" + dr + "," + dr + " 0 0,1 " + d.target.x + "," + d.target.y;
            }

            function transform(d) {
                return "translate(" + d.x + "," + d.y + ")";
            }
        });
        Chain().apply(null, chainArray);
    });
</script>
</body>